#!/usr/bin/env php
<?php

/*
Master file of all wikis:
	all.dblist

Exceptions list:
	special.dblist

Generated by this script:
	wikibooks.dblist
	wikinews.dblist
	wikipedia.dblist
	wikiquote.dblist
	wikisource.dblist
	wiktionary.dblist
	wikimedia.dblist
	wikivoyage.dblist

The split-out files are used by the backup script.

Split by cluster:
	s1.dblist
	s2.dblist
	s3.dblist

*/

$base = "/home/wikipedia/common";

# Puppet provision the realm in /etc/wikimedia-realm
$realm   = 'production';
if( file_exists( '/etc/wikimedia-realm' ) ) {
	$realm = trim( file_get_contents( '/etc/wikimedia-realm' ) );
}
switch($realm) {
case 'labs':
case 'production':
	break;
default:
	$realm = 'production';
	break;
}

$defaultCluster = 's3';
$clusterOverrides = loadClusterList(getRealmedFilename("$base/wmf-config/db.php"));
$clusterAssignments = array();


$all = array_filter(array_map('trim', file(getRealmedFilename("$base/all.dblist"))));
sort($all);

printf("%d wikis listed in " . basename(getRealmedFilename("$base/all.dblist")) . "...\n", count($all));


$special = array_filter(array_map('trim', file(getRealmedFilename("$base/special.dblist"))));
sort($special);

printf("%d special wikis to be exempted from wikipedia group...\n", count($special));


$suffixes = array(
	"wiki" => "wikipedia",
	"wikinews" => "wikinews",
	"wikibooks" => "wikibooks",
	"wikiquote" => "wikiquote",
	"wikisource" => "wikisource",
	"wiktionary" => "wiktionary",
	"wikimedia" => "wikimedia",
	"wikiversity" => "wikiversity",
	"wikivoyage" => "wikivoyage" );

$groups = array();
$specialMatch = array();

foreach ($all as $wiki) {
	if (isset($clusterOverrides[$wiki])) {
		$cluster = $clusterOverrides[$wiki];
	} else {
		$cluster = $defaultCluster;
	}
	$clusterAssignments[$cluster][] = $wiki;
	
	if (in_array($wiki, $special)) {
		$specialMatch[] = $wiki;
		continue;
	}
	foreach ($suffixes as $suffix => $group) {
		if (substr($wiki, -strlen($suffix)) == $suffix) {
			$groups[$group][] = $wiki;
			continue 2;
		}
	}
	printf("Warning: wiki '%s' matches no known group.\n", $wiki);
}

if (count($special) != count($specialMatch)) {
	printf("Warning: expected %d special wikis, matched %d.\n",
		count($special), count($specialMatch));
}

foreach ($groups as $group => $list) {
	listOut($group, $list);
}

echo "Writing out db cluster assignments...\n";

foreach ($clusterAssignments as $cluster => $list) {
	listOut($cluster, $list);
}

echo "Done.\n";

function loadClusterList($file) {
	$wgDBname = $wgDBuser = $wgDBpassword = '';
	include( $file );

	return $wgLBFactoryConf['sectionsByDB'];
}

function listOut($group, $list) {
	global $base;
	
	$filename = getRealmedFilename("$base/$group.dblist");
	printf("Listing %d wikis in %s...\n", count($list), $filename);
	
	$out = fopen("$filename.new", "xt");
	if ($out) {
		foreach ($list as $wiki) {
			fwrite($out, "$wiki\n");
		}
		fclose($out);
		
		if (file_exists("$filename.bak"))
			unlink("$filename.bak");
		if (file_exists($filename))
			rename($filename, "$filename.bak");
		rename("$filename.new", $filename);
	}
}

function getRealmedFilename($filename) {
	global $realm;

	if ( $realm ) {
		$realmed_filename = preg_replace( '/(\.[^.]*)$/', "$realm$1", $filename );
		if ( file_exists( $realmed_filename ) ) {
			return $realmed_filename;
		}
	}
	return $filename;
}
